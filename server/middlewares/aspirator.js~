const request = require("request");
const cheerio = require('cheerio');
const iconv = require('iconv-lite');

const aspire = (body, classTarget, index) => {
    const $ = cheerio.load(iconv.decode(new Buffer(body), 'ISO-8859-1'));
    return $($(classTarget)[index]).text();
}

module.exports = {
    societe: (dust) => new Promise((callback) => request(target = {
	encoding: null,
	method: 'GET',
	uri: dust.source
    }, (error, response, html) => {
	let data = {};
	if (!error) {
	    const a = dust.zone[0];
	    const b = dust.zone[1];
	    data = {
		siret: aspire(html, a, 9),
		result: {
		    name: aspire(html, a, 1),
		    nameComplement: aspire(html, b, 9),
		    legalForm: aspire(html, a, 15),
		    employeNumber: aspire(html, a, 21),
		    category: aspire(html, b, 19),
		    capital: aspire(html, a, 23),
		    address: aspire(html, a, 3).replace(/\n\s+/g, ""),
		    companyCreated: aspire(html, b, 31),
		    seatCreated: aspire(html, b, 33),
		    rcs: {
			date: aspire(html, b, 17).substring(0,8),
			address: aspire(html, b, 11),
		    },
		    naf: {
			date: aspire(html, b, 29),
			Code: aspire(html, b, 21),
			Activity: aspire(html, b, 23)
		    }
		}
	    };
	}
	return callback(data);
    })),
    score3: (dust) => new Promise((callback) => request({
	encoding: null,
	method: 'GET',
	uri: dust.source
    }, (error, response, html) => {
	let data = { };
	if(!error) {
	    const a = dust.zone[0];
	    data = {
		head: aspire(html, a, 8),
		head2: aspire(html, a, 9)
	    };
	}
	return callback(data);
    }))
};
